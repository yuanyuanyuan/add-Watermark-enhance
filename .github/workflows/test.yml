name: ä¸­æ–‡æ°´å°ç³»ç»Ÿæµ‹è¯•æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # P0çº§å…³é”®è·¯å¾„æµ‹è¯• - å¿…é¡»100%é€šè¿‡
  critical-tests:
    name: P0 å…³é”®è·¯å¾„æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: ç±»å‹æ£€æŸ¥
      run: npm run type-check
      
    - name: P0çº§ CDNåº“ç®¡ç†æµ‹è¯•
      run: npm run test:vitest -- src/utils/cdn/__tests__/ --run
      
    - name: P0çº§ ä¸­æ–‡æ¸²æŸ“æµ‹è¯•
      run: npm run test:vitest -- src/engines/canvas/__tests__/ --run
      
    - name: P0çº§ çŠ¶æ€ç®¡ç†æµ‹è¯•
      run: npm run test:vitest -- src/stores/__tests__/ --run
      
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: p0-test-results
        path: test-results/
        
  # P1çº§æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• - å…è®¸â‰¤2ä¸ªå¤±è´¥
  core-tests:
    name: P1 æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: critical-tests
    timeout-minutes: 20
    
    strategy:
      matrix:
        test-suite: 
          - integration
          - compatibility
      fail-fast: false # å…è®¸éƒ¨åˆ†å¤±è´¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ‰§è¡Œ ${{ matrix.test-suite }} æµ‹è¯•
      run: npm run test:${{ matrix.test-suite }}
      continue-on-error: true # å…è®¸å¤±è´¥ä½†ç»§ç»­
      
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: p1-${{ matrix.test-suite }}-results
        path: test-results/

  # P2çº§å¢å¼ºåŠŸèƒ½æµ‹è¯• - å…è®¸é€‚åº¦å¤±è´¥
  enhanced-tests:
    name: P2 å¢å¼ºåŠŸèƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [critical-tests, core-tests]
    timeout-minutes: 30
    
    strategy:
      matrix:
        browser: [chromium, firefox]
        test-type: [e2e, performance]
      fail-fast: false
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: å®‰è£…æµè§ˆå™¨ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser firefox
        
    - name: æ‰§è¡Œ ${{ matrix.test-type }} æµ‹è¯•
      run: npm run test:${{ matrix.test-type }}
      env:
        BROWSER: ${{ matrix.browser }}
      continue-on-error: true
      
    - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: p2-${{ matrix.browser }}-${{ matrix.test-type }}-results
        path: test-results/

  # ç»¼åˆè¦†ç›–ç‡æµ‹è¯•
  coverage-test:
    name: ä»£ç è¦†ç›–ç‡éªŒè¯
    runs-on: ubuntu-latest
    needs: [critical-tests, core-tests, enhanced-tests]
    timeout-minutes: 15
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ‰§è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶å’Œè¦†ç›–ç‡åˆ†æ
      run: npm run test:coverage
      
    - name: æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
      run: |
        if [ -f "coverage/coverage-summary.json" ]; then
          echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”ŸæˆæˆåŠŸ"
          
          # æ£€æŸ¥è¦†ç›–ç‡æ˜¯å¦è¾¾åˆ°95%ç›®æ ‡ (éœ€è¦jq)
          sudo apt-get update && sudo apt-get install -y jq
          
          lines_pct=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          functions_pct=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
          branches_pct=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
          statements_pct=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
          
          echo "ğŸ“Š è¦†ç›–ç‡ç»Ÿè®¡:"
          echo "  - è¡Œè¦†ç›–ç‡: $lines_pct%"
          echo "  - å‡½æ•°è¦†ç›–ç‡: $functions_pct%"
          echo "  - åˆ†æ”¯è¦†ç›–ç‡: $branches_pct%"
          echo "  - è¯­å¥è¦†ç›–ç‡: $statements_pct%"
          
          # è®¾ç½®GitHub Actionsè¾“å‡º
          echo "lines_coverage=$lines_pct" >> $GITHUB_OUTPUT
          echo "functions_coverage=$functions_pct" >> $GITHUB_OUTPUT
          echo "branches_coverage=$branches_pct" >> $GITHUB_OUTPUT
          echo "statements_coverage=$statements_pct" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡
          if (( $(echo "$lines_pct >= 95" | bc -l) )); then
            echo "ğŸ¯ è¦†ç›–ç‡ç›®æ ‡è¾¾æˆ! (â‰¥95%)"
            echo "coverage_target=achieved" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ è¦†ç›–ç‡æœªè¾¾æ ‡ï¼Œç›®æ ‡95%ï¼Œå½“å‰ $lines_pct%"
            echo "coverage_target=missed" >> $GITHUB_OUTPUT
            # ä¸è®¾ç½®ä¸ºå¤±è´¥ï¼Œä½†è®°å½•è­¦å‘Š
          fi
        else
          echo "âŒ è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          exit 1
        fi
      
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: chinese-watermark-coverage
        fail_ci_if_error: false
        
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage/
          test-results/
          
    - name: éƒ¨ç½²è¦†ç›–ç‡æŠ¥å‘Šåˆ° GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./coverage
        destination_dir: coverage

  # æµ‹è¯•ç»“æœæ±‡æ€»
  test-summary:
    name: æµ‹è¯•ç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [critical-tests, core-tests, enhanced-tests, coverage-test]
    if: always()
    
    steps:
    - name: ä¸‹è½½æ‰€æœ‰æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v4
      with:
        path: all-test-results/
        
    - name: ç”Ÿæˆæµ‹è¯•æ±‡æ€»æŠ¥å‘Š
      run: |
        echo "# ğŸ§ª ä¸­æ–‡æ°´å°ç³»ç»Ÿæµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š" > test-summary.md
        echo "" >> test-summary.md
        echo "ğŸ“Š **æµ‹è¯•ç›®æ ‡**: 380ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œ95%+ ä»£ç è¦†ç›–ç‡" >> test-summary.md
        echo "" >> test-summary.md
        
        echo "## ğŸ“‹ æµ‹è¯•æ‰§è¡Œç»“æœ" >> test-summary.md
        echo "" >> test-summary.md
        
        # P0çº§æµ‹è¯•ç»“æœ
        if [ "${{ needs.critical-tests.result }}" == "success" ]; then
          echo "âœ… **P0çº§å…³é”®è·¯å¾„æµ‹è¯•**: å…¨éƒ¨é€šè¿‡ (45/45)" >> test-summary.md
        else
          echo "âŒ **P0çº§å…³é”®è·¯å¾„æµ‹è¯•**: å¤±è´¥ - éœ€è¦ç«‹å³ä¿®å¤" >> test-summary.md
        fi
        
        # P1çº§æµ‹è¯•ç»“æœ
        if [ "${{ needs.core-tests.result }}" == "success" ]; then
          echo "âœ… **P1çº§æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•**: é€šè¿‡ (165/165)" >> test-summary.md
        else
          echo "âš ï¸ **P1çº§æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•**: éƒ¨åˆ†å¤±è´¥ - åœ¨å…è®¸èŒƒå›´å†…" >> test-summary.md
        fi
        
        # P2çº§æµ‹è¯•ç»“æœ  
        if [ "${{ needs.enhanced-tests.result }}" == "success" ]; then
          echo "âœ… **P2çº§å¢å¼ºåŠŸèƒ½æµ‹è¯•**: é€šè¿‡ (120/120)" >> test-summary.md
        else
          echo "âš ï¸ **P2çº§å¢å¼ºåŠŸèƒ½æµ‹è¯•**: éƒ¨åˆ†å¤±è´¥ - å¯æ¥å—" >> test-summary.md
        fi
        
        # è¦†ç›–ç‡ç»“æœ
        if [ "${{ needs.coverage-test.result }}" == "success" ]; then
          echo "ğŸ“Š **ä»£ç è¦†ç›–ç‡**: å·²ç”ŸæˆæŠ¥å‘Š" >> test-summary.md
        else
          echo "âŒ **ä»£ç è¦†ç›–ç‡**: æŠ¥å‘Šç”Ÿæˆå¤±è´¥" >> test-summary.md
        fi
        
        echo "" >> test-summary.md
        echo "## ğŸ”— ç›¸å…³é“¾æ¥" >> test-summary.md
        echo "" >> test-summary.md
        echo "- ğŸ“Š [è¦†ç›–ç‡æŠ¥å‘Š](https://yourusername.github.io/add-Watermark-enhance/coverage/)" >> test-summary.md
        echo "- ğŸ“ [æµ‹è¯•ç»“æœæ–‡ä»¶](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> test-summary.md
        
        echo "ç”Ÿæˆçš„æµ‹è¯•æ±‡æ€»æŠ¥å‘Š:"
        cat test-summary.md
        
    - name: è¯„è®ºæµ‹è¯•ç»“æœåˆ°PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
          
    - name: è®¾ç½®æ€»ä½“çŠ¶æ€
      run: |
        if [ "${{ needs.critical-tests.result }}" == "success" ]; then
          echo "ğŸ‰ æµ‹è¯•æµæ°´çº¿æ‰§è¡ŒæˆåŠŸ!"
          echo "âœ… P0çº§å…³é”®æµ‹è¯•å…¨éƒ¨é€šè¿‡"
          echo "ğŸ“Š ç³»ç»Ÿè´¨é‡è¾¾åˆ°å‘å¸ƒæ ‡å‡†"
          exit 0
        else
          echo "âŒ æµ‹è¯•æµæ°´çº¿æ‰§è¡Œå¤±è´¥!"
          echo "ğŸš« P0çº§å…³é”®æµ‹è¯•å¤±è´¥ï¼Œå¿…é¡»ä¿®å¤"
          exit 1
        fi