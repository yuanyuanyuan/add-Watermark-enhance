/sc:implement "æŠŠä½¿ç”¨è¯´æ˜åšæˆä¸€ä¸ªç»„ä»¶ï¼Œæ”¾åœ¨é¦–é¡µçš„ä¸‹æ–¹ï¼Œè¿™æ ·ä¸Šé¢æ˜¯å·¥å…·é¦–é¡µï¼Œä¸‹é¢æ˜¯ä½¿ç”¨è¯´æ˜ä¹¦ã€‚"
/sc:implement "å¢åŠ ä¸€ä¸ªçµæ„Ÿæ¥æºæ¨¡å—ï¼Œå¯ä»¥å¡«å†™æ¥æºåç§°å’Œurlï¼Œè¿™ä¸ªæ˜¯å¯ä»¥ç‚¹å‡»çš„urlï¼Œè¿™ä¸ªæ˜¯éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸Šé…ç½®çš„ã€‚"
/sc:implement "å¢åŠ ä¸€ä¸ªä½œè€…æ¨¡å—ï¼Œå¯ä»¥å¡«å†™ä½œè€…åç§°å’Œurlï¼Œè¿™ä¸ªæ˜¯å¯ä»¥ç‚¹å‡»çš„urlï¼Œè¿™ä¸ªæ˜¯éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸Šé…ç½®çš„ã€‚"

/sc:implement "æˆ‘çœ‹åˆ°åˆ«äººçš„å·¥å…·å¯ä»¥æ”¯æŒpdfé‡Œé¢æœ‰ä¸­æ–‡æ°´å°ï¼Œè¦é‡æ–°è°ƒç ”æ¸…æ¥šæ€ä¹ˆå®ç°çš„ï¼Œä»–ç”¨åˆ°   <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
"
/sc:implement "é¢„è§ˆåŒºåŸŸè¦å¤§ä¸€ç‚¹ï¼Œå¦‚æœé¢„è§ˆå†…å®¹è¿‡é•¿ï¼Œè¦æ”¯æŒæ»šåŠ¨"

/sc:troubleshoot "ä¿®å¤æ‰€æœ‰ç±»å‹æ£€æŸ¥æŠ¥é”™å’Œbuild æŠ¥é”™"


/sc:troubleshoot "åœ¨pdfæ·»åŠ æ°´å°ä¸­ï¼Œæ·»åŠ ä¸Šä¸­æ–‡æ°´å°ï¼Œä½†æ˜¯é¢œè‰²ä¸èƒ½ä¿®æ”¹ï¼Œéœ€è¦ä¿®å¤ï¼Œå¦å¤–éœ€è¦æŠŠå®Œæ•´çš„ç”¨æˆ·é€‰æ‹©å‚æ•°ä¹Ÿæ‰“å°åˆ°æ§åˆ¶é¢æ¿ï¼Œæ–¹ä¾¿è¿›è¡Œè°ƒè¯•"

/sc:troubleshoot " åœ¨wordè½¬pdfä¸­ï¼Œè½¬æ¢åä¸¢å¤±äº†wordçš„å†…å®¹ï¼Œæ°´å°èƒ½æ·»åŠ ä¸Šï¼Œä½†æ˜¯æ°´å°çš„å±æ€§ä¸¢å¤±å¾ˆå¤šï¼Œä¾‹å¦‚é¢œè‰²ä¸¢äº†ã€‚ï¼Œéœ€è¦ä¿®å¤ï¼š


    "

/sc:implement "ä¸ºäº†è§£å†³ä¸­æ–‡æ°´å°çš„é—®é¢˜ï¼Œæˆ‘æ‰¾äº†ä¸€ä¸ªæŠ€æœ¯æ–¹æ¡ˆæ¥ååŠ©å®Œæˆå®ç°ï¼š

 ğŸ” æ ¸å¿ƒåŠŸèƒ½æ·±åº¦æŠ€æœ¯è§£æ

  1ï¸âƒ£ ä¸­æ–‡æ°´å°Canvasæ¸²æŸ“æœºåˆ¶ - æŠ€æœ¯çªç ´

  æ ¸å¿ƒé—®é¢˜: PDFåŸç”Ÿå¯¹ä¸­æ–‡å­—ä½“æ”¯æŒæœ‰é™ï¼Œç›´æ¥ç»˜åˆ¶ä¸­æ–‡æ–‡æœ¬å¯èƒ½å‡ºç°ä¹±ç æˆ–æ˜¾ç¤ºå¼‚å¸¸

  åˆ›æ–°è§£å†³æ–¹æ¡ˆ: Canvasæ¸²æŸ“ + PNGåµŒå…¥æŠ€æœ¯

  // demo.html:2308 - addChineseWatermarkå‡½æ•°
  async function addChineseWatermark(pdfDoc, page, watermarkText, x, y, fontSize, color, opacity, rotation) {
      // åˆ›å»ºCanvasè¿›è¡Œä¸­æ–‡æ¸²æŸ“
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // è®¾ç½®ä¸­æ–‡å­—ä½“ - å…³é”®åˆ›æ–°ç‚¹
      ctx.font = `${fontSize}px "Microsoft YaHei", "SimSun", sans-serif`;

      // åŠ¨æ€è®¡ç®—æ–‡æœ¬å°ºå¯¸å’Œæ—‹è½¬è¾¹ç•Œæ¡†
      const metrics = ctx.measureText(watermarkText);
      const radians = (rotation * Math.PI) / 180;
      const rotatedWidth = Math.abs(textWidth * Math.cos(radians)) + Math.abs(textHeight * Math.sin(radians));

      // è®¾ç½®å¸¦é€æ˜åº¦çš„é¢œè‰²
      const r = parseInt(color.substr(1, 2), 16);
      const g = parseInt(color.substr(3, 2), 16);
      const b = parseInt(color.substr(5, 2), 16);
      ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${opacity})`;

      // è½¬æ¢ä¸ºPNGå¹¶åµŒå…¥PDF
      const imageData = canvas.toDataURL('image/png');
      const image = await pdfDoc.embedPng(imageData);
      page.drawImage(image, {...});
  }

  æŠ€æœ¯ä¼˜åŠ¿:
  - âœ… å®Œç¾ç»•è¿‡PDFä¸­æ–‡å­—ä½“é™åˆ¶
  - âœ… æ”¯æŒä»»æ„ä¸­æ–‡å†…å®¹æ¸²æŸ“
  - âœ… ç²¾ç¡®æ§åˆ¶é€æ˜åº¦ã€é¢œè‰²ã€æ—‹è½¬è§’åº¦
  - âœ… æ¸²æŸ“è´¨é‡é«˜ï¼Œæ”¯æŒå¤šç§ä¸­æ–‡å­—ä½“

  2ï¸âƒ£ DOCXå†…å®¹æå–ä¸‰é‡ä¿éšœæœºåˆ¶

  æ ¸å¿ƒé—®é¢˜: DOCXæ–‡ä»¶ç»“æ„å¤æ‚ï¼Œå•ä¸€è§£ææ–¹æ³•å¯èƒ½å¤±è´¥

  åˆ›æ–°è§£å†³æ–¹æ¡ˆ: å¤šå±‚æ¬¡å®¹é”™è§£æç­–ç•¥

  // demo.html:1785 - processDOCå‡½æ•°
  async function processDOC(file, watermarkText, fontSize, opacity, rotation, color) {
      // ç¬¬ä¸€é‡ï¼šMammothåº“è§£æ
      try {
          const result = await mammoth.extractRawText({ arrayBuffer: bufferVariants[i] });
          if (result.value && result.value.trim().length > 0) {
              extractedText = result.value;
              extractionSuccess = true;
          }
      } catch (mammothError) {
          console.warn('Mammothè§£æå¤±è´¥ï¼Œå°è¯•JSZip');
      }

      // ç¬¬äºŒé‡ï¼šJSZipç›´æ¥è§£æ
      if (!extractionSuccess) {
          const zip = await JSZip.loadAsync(bufferVariants[i]);
          const documentXml = await zip.file('word/document.xml').async('text');
          const textContent = documentXml
              .replace(/<[^>]*>/g, '')  // ç§»é™¤XMLæ ‡ç­¾
              .replace(/\s+/g, ' ')     // åˆå¹¶ç©ºæ ¼
              .trim();
      }

      // ç¬¬ä¸‰é‡ï¼šæ–‡ä»¶æ ¼å¼æ™ºèƒ½è¯†åˆ«
      const fileSignature = uint8Array.slice(0, 4);
      const isRealDocx = fileSignature[0] === 0x50 && fileSignature[1] === 0x4B; // PK
      const isRealDoc = fileSignature[0] === 0xD0 && fileSignature[1] === 0xCF;  // OLE2
  }

  æŠ€æœ¯ä¼˜åŠ¿:
  - âœ… ä¸‰é‡ä¿éšœç¡®ä¿å†…å®¹æå–æˆåŠŸç‡
  - âœ… æ™ºèƒ½è¯†åˆ«çœŸå®æ–‡ä»¶æ ¼å¼ï¼Œé¿å…æ‰©å±•åè¯¯å¯¼
  - âœ… æ”¯æŒå¤šç§bufferå˜ä½“å¤„ç†ï¼Œæé«˜å®¹é”™æ€§
  - âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯

  3ï¸âƒ£ æ–‡ä»¶æ ¼å¼æ™ºèƒ½è¯†åˆ«æœºåˆ¶

  æ ¸å¿ƒé—®é¢˜: æ–‡ä»¶æ‰©å±•åå¯èƒ½è¢«ä¿®æ”¹æˆ–ä¼ªè£…ï¼Œå½±å“å¤„ç†ç­–ç•¥

  åˆ›æ–°è§£å†³æ–¹æ¡ˆ: æ–‡ä»¶å¤´ç­¾åè¯†åˆ«æŠ€æœ¯

  // demo.html:1804-1816 - æ–‡ä»¶æ ¼å¼æ£€æµ‹
  const uint8Array = new Uint8Array(arrayBuffer);
  const fileSignature = uint8Array.slice(0, 4);

  // ZIPæ ¼å¼ (DOCX) æ£€æµ‹ - PKæ ‡è¯†
  const isRealDocx = fileSignature[0] === 0x50 && fileSignature[1] === 0x4B;

  // OLE2æ ¼å¼ (è€ç‰ˆæœ¬DOC) æ£€æµ‹
  const isRealDoc = fileSignature[0] === 0xD0 && fileSignature[1] === 0xCF;

  console.log('æ–‡ä»¶ç±»å‹æ£€æµ‹:');
  console.log('- æ˜¯çœŸæ­£çš„DOCX (ZIPæ ¼å¼):', isRealDocx);
  console.log('- æ˜¯è€ç‰ˆæœ¬DOC (OLE2æ ¼å¼):', isRealDoc);
  console.log('- æ–‡ä»¶æ‰©å±•å:', file.name.toLowerCase().split('.').pop());

  æŠ€æœ¯ä¼˜åŠ¿:
  - âœ… ç²¾å‡†è¯†åˆ«çœŸå®æ–‡ä»¶æ ¼å¼ï¼Œä¸å—æ‰©å±•åå½±å“
  - âœ… æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼è‡ªåŠ¨è¯†åˆ«
  - âœ… ä¸ºä¸åŒæ ¼å¼é‡‡ç”¨æœ€ä¼˜å¤„ç†ç­–ç•¥

  4ï¸âƒ£ PDFç»Ÿä¸€è¾“å‡ºæ¶æ„

  æ ¸å¿ƒé—®é¢˜: éœ€è¦å°†ä¸åŒæ ¼å¼çš„æ–‡æ¡£ç»Ÿä¸€è½¬æ¢ä¸ºPDFå¹¶æ·»åŠ æ°´å°

  åˆ›æ–°è§£å†³æ–¹æ¡ˆ: åŸºäºpdf-libçš„PDFåˆ›å»ºå’Œæ°´å°æ·»åŠ 

  // demo.html:1922 - PDFåˆ›å»ºå’Œæ°´å°æ·»åŠ 
  const pdfDoc = await PDFLib.PDFDocument.create();

  // æ·»åŠ æå–çš„æ–‡æœ¬å†…å®¹
  if (extractionSuccess && extractedText) {
      pdfDoc.registerFontkit(fontkit);
      const chineseFont = await loadChineseFont(pdfDoc);

      // æ¸²æŸ“æ–‡æœ¬å†…å®¹åˆ°PDFé¡µé¢
      await renderTextWithCanvas(pdfDoc, currentPage, lineText, 50, y, fontSize);
  }

  // æ·»åŠ ç½‘æ ¼çŠ¶æ°´å°è¦†ç›–
  const pages = pdfDoc.getPages();
  for (const page of pages) {
      // ä¸­å¿ƒæ°´å°
      await addWatermarkToPage(pdfDoc, page, watermarkText, width/2, height/2, fontSize, color, opacity, rotation);     

      // ç½‘æ ¼çŠ¶æ°´å°è¦†ç›–
      for (let x = 100; x < width; x += 200) {
          for (let y = 100; y < height; y += 200) {
              await addWatermarkToPage(pdfDoc, page, watermarkText, x, y, fontSize*0.8, color, opacity*0.5,
  rotation);
          }
      }
  }

  æŠ€æœ¯ä¼˜åŠ¿:
  - âœ… ç»Ÿä¸€çš„PDFè¾“å‡ºæ ¼å¼ï¼Œä¾¿äºåˆ†å‘å’ŒæŸ¥çœ‹
  - âœ… ç½‘æ ¼çŠ¶æ°´å°è¦†ç›–ï¼Œæé«˜æ–‡æ¡£å®‰å…¨æ€§
  - âœ… æ”¯æŒå¤šé¡µé¢æ–‡æ¡£å¤„ç†
  - âœ… ç²¾ç¡®æ§åˆ¶æ°´å°ä½ç½®å’Œæ ·å¼

  5ï¸âƒ£ æŠ€æœ¯ä¼˜åŠ¿ä¸åˆ›æ–°ç‚¹æ€»ç»“

â— ğŸš€ æ ¸å¿ƒæŠ€æœ¯ä¼˜åŠ¿æ€»ç»“

  ğŸ¯ ä¸»è¦æŠ€æœ¯çªç ´

  1. ä¸­æ–‡æ°´å°å®Œç¾æ”¯æŒ
    - Canvasæ¸²æŸ“æŠ€æœ¯ç»•è¿‡PDFä¸­æ–‡å­—ä½“é™åˆ¶
    - æ”¯æŒä»»æ„ä¸­æ–‡å†…å®¹ã€é¢œè‰²ã€é€æ˜åº¦ã€æ—‹è½¬è§’åº¦
    - æ¸²æŸ“è´¨é‡é«˜ï¼Œå…¼å®¹æ€§å¥½
  2. æ™ºèƒ½æ–‡ä»¶å¤„ç†
    - æ–‡ä»¶å¤´ç­¾åè¯†åˆ«ï¼Œé¿å…æ‰©å±•åè¯¯å¯¼
    - ä¸‰é‡ä¿éšœæœºåˆ¶ç¡®ä¿å†…å®¹æå–æˆåŠŸç‡
    - æ”¯æŒPDFã€DOCã€DOCXå¤šç§æ ¼å¼
  3. ç»Ÿä¸€PDFè¾“å‡º
    - æ‰€æœ‰æ ¼å¼ç»Ÿä¸€è½¬æ¢ä¸ºPDF
    - ç½‘æ ¼çŠ¶æ°´å°è¦†ç›–æé«˜å®‰å…¨æ€§
    - æ”¯æŒå¤šé¡µé¢æ–‡æ¡£å¤„ç†

  ğŸ”§ æŠ€æœ¯æ¶æ„ä¼˜åŠ¿

  ä¾èµ–åº“ååŒå·¥ä½œ:
  - pdf-lib: PDFåˆ›å»ºå’Œç¼–è¾‘æ ¸å¿ƒ
  - mammoth: DOCXå†…å®¹æå–
  - JSZip: ZIPç»“æ„è§£æ
  - fontkit: å­—ä½“æ”¯æŒ

  å®¹é”™æœºåˆ¶å®Œå–„:
  - å¤šç§bufferå˜ä½“å¤„ç†
  - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
  - ä¼˜é›…çš„é™çº§ç­–ç•¥

  ğŸ’¡ åˆ›æ–°åº”ç”¨ä»·å€¼

  1. è§£å†³å®é™…é—®é¢˜: å®Œç¾è§£å†³äº†PDFä¸­æ–‡å­—ä½“æ”¯æŒçš„ä¸šç•Œéš¾é¢˜
  2. æé«˜æ•ˆç‡: è‡ªåŠ¨åŒ–çš„æ–‡æ¡£å¤„ç†æµç¨‹ï¼Œç”¨æˆ·æ“ä½œç®€å•
  3. å¢å¼ºå®‰å…¨æ€§: ç½‘æ ¼çŠ¶æ°´å°è¦†ç›–ï¼Œæœ‰æ•ˆé˜²æ­¢å†…å®¹ç›—ç”¨
  4. å…¼å®¹æ€§å¼º: æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼Œé€‚åº”ä¸åŒç”¨æˆ·éœ€æ±‚

"